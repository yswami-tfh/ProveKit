name: Generate Age Check Circuit Keys

on:
  workflow_dispatch:

env:
  BUCKET_NAME: "provekit"
  CIRCUIT_NAME: "complete_age_check"
  CIRCUIT_DIR: "noir-examples/noir-passport-examples/complete_age_check"
  KEYS_NAME: "agecheck_pk_03Nov_07-35-45"


permissions:
  contents: read

jobs:
    generate-circuit-keys:
        name: Generate Age Check Circuit Keys
        runs-on: [self-hosted, Linux, ARM64, provekit-build]
        steps:
            - uses: actions/checkout@v4

            - name: Setup Rust toolchain, cache and bins
              uses: moonrepo/setup-rust@v1
              with:
                  channel: nightly-2025-04-05
                  cache-base: main
                  components: rustfmt, clippy

            - name: Check gsutil
              run: |
                which gsutil || echo "gsutil not found"
                gsutil --version

            - name: Build provekit-cli
              run: cargo build --release --bin provekit-cli

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: 1.24

            - name: Setup Noir toolchain
              uses: noir-lang/noirup@v0.1.2
              with:
                  toolchain: v1.0.0-beta.11

            - name: Compile and execute Nargo circuit
              working-directory: ${{ env.CIRCUIT_DIR }}
              run: |
                nargo compile --skip-brillig-constraints-check --force

            - name: Generate Gnark inputs
              working-directory: ${{ env.CIRCUIT_DIR }}
              run: |
                cargo run --release --bin provekit-cli prepare ./target/${{ env.CIRCUIT_NAME }}.json -p ./noir-provekit-prover.pkp -v ./noir-provekit-verifier.pkv
                cargo run --release --bin provekit-cli prove ./noir-provekit-prover.pkp ./Prover.toml -o ./noir-proof.np
                cargo run --release --bin provekit-cli generate-gnark-inputs ./noir-provekit-prover.pkp ./noir-proof.np
                
            - name: Run Gnark verifier
              working-directory: recursive-verifier
              run: |
                go run cmd/cli/main.go --config "../${{ env.CIRCUIT_DIR }}/params_for_recursive_verifier" --r1cs "../${{ env.CIRCUIT_DIR }}/r1cs.json" --saveKeys "./keys"

            - name: List keys
              working-directory: recursive-verifier
              run: |
                ls -la ./keys/*.bin || echo "No keys"

            - name: Upload keys to gcp
              working-directory: recursive-verifier
              run: |
                PK_FILE=$(ls -t ./keys/pk_*.bin 2>/dev/null | head -1)
                VK_FILE=$(ls -t ./keys/vk_*.bin 2>/dev/null | head -1)

                if [ -z "$PK_FILE" ] || [ -z "$VK_FILE" ]; then
                  echo "Error: Could not find keys"
                  exit 1
                fi
              
                echo "Found PK file: $PK_FILE"
                echo "Found VK file: $VK_FILE"

                AGE_CHECK_PK_NAME="${{ env.KEYS_NAME }}_$(basename "$PK_FILE")"
                AGE_CHECK_VK_NAME="${{ env.KEYS_NAME }}_$(basename "$VK_FILE")"

                echo "Uploading PK as: $AGE_CHECK_PK_NAME"
                echo "Uploading VK as: $AGE_CHECK_VK_NAME"

                gsutil cp "$PK_FILE" "gs://${{ env.BUCKET_NAME }}/$AGE_CHECK_PK_NAME"
                gsutil cp "$VK_FILE" "gs://${{ env.BUCKET_NAME }}/$AGE_CHECK_VK_NAME"

            - name: Cleanup local files 
              working-directory: recursive-verifier
              run: |
                echo "Cleaning up local keys..."
                rm -f ./keys/*.bin

